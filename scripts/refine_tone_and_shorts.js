const fs = require('fs');

function createRng(seed = 20260208) {
  let s = seed >>> 0;
  return function rng() {
    s = (s * 1664525 + 1013904223) >>> 0;
    return s / 4294967296;
  };
}
const rng = createRng();
const pick = (arr) => arr[Math.floor(rng() * arr.length)];

function norm(s) {
  return s.toLowerCase().replace(/[^\p{L}\p{N}\s]/gu, ' ').replace(/\s+/g, ' ').trim();
}
function grams3(s) {
  const t = norm(s).replace(/\s/g, '');
  if (t.length < 3) return new Set([t]);
  const out = new Set();
  for (let i = 0; i <= t.length - 3; i += 1) out.add(t.slice(i, i + 3));
  return out;
}
function jaccard(a, b) {
  let inter = 0;
  for (const x of a) if (b.has(x)) inter += 1;
  const union = a.size + b.size - inter;
  return union === 0 ? 1 : inter / union;
}

function toBanmal(line) {
  let t = line;
  const rules = [
    [/\b입니다\./g, '이야.'],
    [/\b입니다\b/g, '이야'],
    [/\b맞습니다\./g, '맞아.'],
    [/\b맞습니다\b/g, '맞아'],
    [/\b있습니다\./g, '있어.'],
    [/\b있습니다\b/g, '있어'],
    [/\b없습니다\./g, '없어.'],
    [/\b없습니다\b/g, '없어'],
    [/\b됩니다\./g, '돼.'],
    [/\b됩니다\b/g, '돼'],
    [/\b필요합니다\./g, '필요해.'],
    [/\b필요합니다\b/g, '필요해'],
    [/\b권장합니다\./g, '권장해.'],
    [/\b권장합니다\b/g, '권장해'],
    [/\b보입니다\./g, '보여.'],
    [/\b보입니다\b/g, '보여'],
    [/\b같습니다\./g, '같아.'],
    [/\b같습니다\b/g, '같아'],
    [/\b합니다\./g, '해.'],
    [/\b합니다\b/g, '해'],
    [/\b세요\./g, '해.'],
    [/\b세요\b/g, '해'],
    [/\b까요\?/g, '까?'],
    [/\b인가요\?/g, '인가?'],
    [/\b맞나요\?/g, '맞냐?'],
    [/\b가능할까요\?/g, '가능할까?'],
    [/\b될까요\?/g, '될까?'],
    [/\b좋습니다\./g, '좋다.'],
    [/\b좋습니다\b/g, '좋다'],
    [/\b고맙습니다\./g, '고맙다.'],
    [/\b죄송합니다\./g, '미안.'],
  ];
  for (const [re, rep] of rules) t = t.replace(re, rep);
  t = t.replace(/\s+/g, ' ').trim();
  return t;
}

function mkShortGenerator(def) {
  return function gen() {
    const a = pick(def.a);
    const b = pick(def.b);
    const c = pick(def.c);
    const em = pick(def.em);
    const p = pick(def.p);
    const tail = pick(def.tail);

    const patterns = [
      `${a}${p}`,
      `${em} ${a}${p}`,
      `${a}, ${b}${p}`,
      `${b}${p}`,
      `${a} ${c}${p}`,
      `${em} ${b}${p}`,
      `${a} ${tail}${p}`,
      `${a} / ${b}${p}`,
      `${c}${p}`,
      `${a} ${b} ${tail}${p}`,
      `${tail}${p}`,
      `${em} ${a} ${tail}${p}`,
      `${a} -> ${b}${p}`,
      `${a} ${b}${p}`,
      `${a} ${c} ${tail}${p}`,
    ];
    return pick(patterns).replace(/\s+/g, ' ').trim();
  };
}

const defs = {
  greeting: {
    a: ['유하', '유하!!', '하이', '왔어', '입장완', '출첵', '본방 왔다', '합류', '들어옴', '채팅 켰다', '나 왔어', '출석', '등장'],
    b: ['시작부터 세다', '도입 강하네', '공기 무겁다', '기류 쎄다', '분위기 미쳤다', '첫컷 좋다', '몰입 확 온다', '오늘 판 빡세다', '긴장 바로 온다', '이거 각 나왔다'],
    c: ['리얼루', '진짜', '와', '헐', 'ㄹㅇ', '오우', '미쳤네', '레전드', '폼 좋다', '감 좋다'],
    em: ['ㅋㅋ', 'ㄷㄷ', '와', '헐', '리얼루', '유하!!!', '오', '캬', '와우', '진심'],
    tail: ['개좋다', '빡몰입', '쎄하네', '텐션 오른다', '분위기 먹었다', '시작부터 장난 아니다', '첫인상 강하다', '오늘 길다', '기대된다', '이거 된다'],
    p: ['', '!', '!!', '!!!', 'ㅋㅋ', 'ㄷㄷ', '?!'],
  },
  question: {
    a: ['지금 뭐함', '어디 가는 중', '오늘 어디 탐험 중', '이대로 가', '멈출까', '더 볼까', '지금 맞냐', '진행 맞냐', '지금 단계 뭐냐', '다음 뭐함', '이동 계속함', '여기서 대기함'],
    b: ['이 타이밍 맞냐', '지금 판단 괜찮냐', '리스크 큰가', '지금 밀어도 되냐', '한 템포 늦출까', '지금 흐름 맞냐', '트리거냐', '페이크냐', '지금 보류하냐', '계속 진행하냐'],
    c: ['어떻게 볼래', '어떻게 갈까', '뭐가 맞냐', '지금 뭐가 최선', '다음 선택 뭐냐', '지금 기준 뭐냐', '어느 쪽이냐', '합의하자', '한 번만 더 체크?', '이거 맞지?'],
    em: ['ㅋㅋ', 'ㄷㄷ', '와', '헐', '리얼루', '진심', '오', '음', '흠', '엇'],
    tail: ['빠르게 정하자', '천천히 가자', '안전하게 가자', '판단 다시 보자', '체크 먼저 하자', '흐름 안 놓치자', '괜히 밀지 말자', '합의하고 가자', '리스크 줄이자', '멈춤도 선택이다'],
    p: ['?', '??', '?!', 'ㅋㅋ?', 'ㄷㄷ?', ''],
  },
  horror: {
    a: ['리얼루 무섭다', '소름 돋는다', '등골 서늘', '숨 막힌다', '정적 개무섭다', '압박감 크다', '심장 쿵한다', '기류 미쳤다', '눈 못 떼겠다', '손에 땀난다', '긴장 안 풀린다', '쫄린다'],
    b: ['공기 차갑다', '분위기 살벌하다', '체감 난도 높다', '멘탈 깎인다', '진심 세다', '공포 밀도 높다', '여운 길다', '계속 무섭다', '바짝 긴장됨', '숨 고르게 된다'],
    c: ['진짜', '리얼루', '와', '헐', 'ㄹㅇ', '개쎄다', '장난 아니다', '오바다', '미쳤다', '실화냐'],
    em: ['ㅋㅋ', 'ㄷㄷ', '와', '헐', '리얼루', '진심', '아', '하', '오', '으'],
    tail: ['못 보겠다', '눈 돌리기 힘들다', '심박 오른다', '후퇴하고 싶다', '한숨 나온다', '버겁다', '압박 심하다', '숨 참게 된다', '몰입 과하다', '긴장선 높다'],
    p: ['', '!', '!!', 'ㄷㄷ', 'ㅋㅋ', '...'],
  },
  warning: {
    a: ['멈춰', '가지 마', '속도 줄여', '후퇴해', '다시 봐', '확인 먼저', '무리 ㄴㄴ', '지금 보류', '잠깐 대기', '진입 금지', '리스크 큼', '욕심 금지'],
    b: ['지금 위험', '타이밍 아냐', '한 걸음 빼', '판단 다시', '안전 우선', '지금은 대기', '침착하게 가', '급하면 당함', '재확인 필수', '천천히'],
    c: ['뒤 봐', '호흡해', '멈칫해', '한 번 더 체크', '동선 바꿔', '지금 브레이크', '각도 다시', '리셋해', '정리하고 가', '라인 바꿔'],
    em: ['ㅋㅋ', 'ㄷㄷ', '와', '헐', '진심', '지금', '당장', '빨리', '잠깐', '리얼루'],
    tail: ['지금은 아님', '이건 위험', '밀지 마', '안전빵 가', '후퇴가 답', '생존 우선', '이득 없음', '급할수록 천천히', '검증 먼저', '멈춤이 정답'],
    p: ['', '!', '!!', 'ㄷㄷ', 'ㅋㅋ'],
  },
  troll: {
    a: ['클립각', '밈각', '예능각', '드립각', '유령도 본다', '조회수각', '썸네일 확정', '리액션 맛집', '편집자 행복', '이거 터진다', '폼 미쳤다', '웃기네'],
    b: ['레전드', '개웃김', '오늘 폼 좋다', '채팅 폭발', '다시보기 각', '미친 타이밍', '진짜 웃프다', '이건 된다', '유하각', '명장면'],
    c: ['ㅋㅋ', 'ㄷㄷ', '와', '헐', '리얼루', '진심', '오바', '미쳤네', '하하', '캬'],
    em: ['ㅋㅋ', 'ㅋㅋㅋ', 'ㄷㄷ', '와', '헐', '리얼루', '유하!!!', '진심', '아니', '오'],
    tail: ['웃음 터짐', '클립 박제', '밈 확정', '오늘 대박', '시청률 오른다', '채팅 미친다', '반응 미쳤다', '리액션 찐', '각 제대로', '이거다'],
    p: ['', '!', '!!', 'ㅋㅋ', 'ㄷㄷ'],
  },
  support: {
    a: ['잘한다', '잘하고 있다', '페이스 좋다', '판단 좋다', '천천히 가', '침착해', '호흡해', '유지해', '끝까지 가자', '버티는 거 좋다', '지금 좋다', '좋아 계속'],
    b: ['지금처럼 가', '안전하게 가', '완주 가능', '멘탈 좋다', '충분히 가능', '실수 없다', '리듬 좋다', '응원한다', '잘 버틴다', '이 페이스 굿'],
    c: ['리얼루', '진심', 'ㄹㅇ', '와', '좋다', '멋지다', '든든하다', '괜찮다', '잘한다', '좋네'],
    em: ['ㅋㅋ', 'ㄷㄷ', '와', '헐', '리얼루', '진심', '오', '좋다', '굿', '파이팅'],
    tail: ['계속 이렇게', '안정적으로 가', '끝까지 간다', '집중 유지', '차분하게', '선택 좋다', '지금 흐름 좋다', '리스크 관리 좋다', '버티면 이긴다', '조급해지지 마'],
    p: ['', '!', '!!', 'ㅋㅋ', 'ㄷㄷ'],
  },
  analysis: {
    a: ['패턴 이상', '값 튄다', '신호 이상', '로그 이상', '노이즈 뜀', '지표 흔들림', '간격 이상', '변동 큼', '정상 아님', '재확인 필요', '수치 흔들림', '이상치다'],
    b: ['우연 아님', '반복 신호다', '복합 원인 같다', '재측정 각', '근거 남는다', '패턴 잡힘', '값 불안정', '지표 깨짐', '설명 안 됨', '이건 남는다'],
    c: ['분석상', '체크상', '로그상', '데이터상', '통계상', '감지됨', '포착됨', '기록됨', '확인됨', '재현됨'],
    em: ['ㅋㅋ', 'ㄷㄷ', '와', '헐', '리얼루', '진심', '오', '흠', '음', '엇'],
    tail: ['한 번 더 보자', '값 다시 찍자', '로그 저장', '근거 충분', '이상 신호 유지', '추적 필요', '관찰 계속', '리뷰 필요', '검증 필요', '재현 체크'],
    p: ['', '!', '!!', 'ㄷㄷ', 'ㅋㅋ'],
  },
  jumpscare_react: {
    a: ['뭐야', '깜짝이야', '와씨 놀람', '개놀람', '심장 떨어짐', '비명 나올 뻔', '아 깜놀', '손 떨림', '맥박 튐', '와 미쳤다', '진짜 당함', '숨 멎는 줄'],
    b: ['반칙이다', '타이밍 뭐냐', '너무 세다', '후유증 온다', '맥박 안 내려감', '다시 못 보겠다', '완전 사각', '이건 선 넘음', '개무섭다', '심장 테스트다'],
    c: ['리얼루', '진심', '와', '헐', 'ㄹㅇ', '아', '오', '미쳤다', '장난 아냐', '실화냐'],
    em: ['ㅋㅋ', 'ㄷㄷ', '와', '헐', '리얼루', '진심', '아', '야', '엇', '우와'],
    tail: ['손에 땀남', '숨 고른다', '후유증 남는다', '여운 길다', '다시보기 힘들다', '체감 두 배', '심박 오른다', '진정 안 됨', '볼륨 낮춘다', '잠깐 쉰다'],
    p: ['', '!', '!!', 'ㄷㄷ', 'ㅋㅋ'],
  },
};

const data = JSON.parse(fs.readFileSync('chat.json', 'utf8'));

for (const [cat, arr] of Object.entries(data.chat)) {
  for (const item of arr) item.text = toBanmal(item.text);

  const base = arr.slice(0, 300);
  const used = new Set(base.map((x) => x.text));
  const grams = base.map((x) => grams3(x.text));
  const gen = mkShortGenerator(defs[cat]);

  const added = [];
  let guard = 0;
  while (added.length < 200 && guard < 3000000) {
    guard += 1;
    let line = gen();
    line = line.replace(/\s+/g, ' ').trim();
    if (!line) continue;
    if (used.has(line)) continue;

    const g = grams3(line);
    let tooClose = false;
    for (const prev of grams) {
      if (jaccard(g, prev) >= 0.93) {
        tooClose = true;
        break;
      }
    }
    if (tooClose) continue;

    used.add(line);
    grams.push(g);
    added.push({ text: line });
  }

  if (added.length !== 200) {
    throw new Error(`${cat} short generation failed ${added.length}/200`);
  }

  data.chat[cat] = base.concat(added);
}

fs.writeFileSync('chat.json', JSON.stringify(data, null, 2) + '\n');

for (const [k, v] of Object.entries(data.chat)) {
  const polite = v.filter((x) => /(요\?|요$|습니다|습니까|세요|할까요|인가요|맞나요)/.test(x.text)).length;
  console.log(k, v.length, 'polite_like', polite);
}
